---
title: 架构决策记录 (ADR)
description: 本项目的技术架构决策和理由
scope: project  
priority: high
---

# 架构决策记录

## 为什么选择 TypeScript + Node.js 而不是 Python

### ✅ 优势 (Node.js/TS)
- **一个技术栈** - 前端/后端统一用 JS/TS，降低学习成本
- **LangChain 支持完善** - JS 版 LangChain 生态成熟
- **异步 I/O 性能** - 天生适合处理 LLM 请求的高并发场景
- **易于部署** - 无需 Python 环境，一个 node 进程搞定
- **DOM 操作能力** - 方便后续扩展爬虫或Web自动化

### ⚠️ 放弃 Python 的代价
- Python 生态在 AI 领域更传统
- 但 Node.js 的 LangChain 已经足够完善

**决策**: ✅ **使用 Node.js + TypeScript**

---

## 为什么选择 LangGraph 而不是 LangChain 自定义链

### LangGraph 优势
1. **状态管理** - 原生支持状态机，完美契合"意图→状态→计划→执行"流程
2. **可视化调试** - 可以导出状态图，便于理解执行流
3. **条件分支** - 缓存命中/未命中、重试逻辑更清晰
4. **断点续传** - 支持中途停止，适合人工介入场景

### 实际使用
```typescript
// 虽不是严格 LangGraph，但我们实现了类似的流程编排
// 这是权衡后的结果：保持代码可读性，同时不引入过多复杂性
```

**决策**: ✅ **使用 LangGraph 理念，结合手动编排** (保持代码简洁)

---

## 为什么 Home Assistant 作为唯一真实状态源

### 架构决策
```
系统设计原则:
LLM 只做理解与决策
HA 只做状态与执行
所有操作必须可回滚
```

### 为什么不分设备给其他平台
- **米家云** → 不稳定，无官方 API
- **Node-RED** → 可视化强，但不可靠，不如直接代码
- **自建 MQTT** → 维护成本高

**决策**: ✅ **HA 是唯一的设备控制网关**

---

## 缓存策略决策

### 问题背景
"我要洗澡了" 这句话在不同场景下：
- 晚上10点，有人在家 → 标准流程
- 晚上12点，刚回家 → 可能不需要浴霸
- 夏天，没人在家 → 可能只开灯

### 解决方案
**Context-Aware 缓存**
```typescript
cacheKey = `context:${intent}:${hash(上下文)}`
// 包含: 时间段、温度、人在/不在、最近操作
```

### 缓存失效机制
```
1. 时间>1小时 → 自动失效
2. 成功率<0.3 → 删除
3. 上下文严重不符 → 重新规划
```

**决策**: ✅ **上下文感知的智能缓存**

---

## API 层设计决策

### HTTP vs WebSocket

#### 为什么不用 WebSocket
- 家庭场景请求频率低
- 没有实时双向需求
- HTTP 更简单，调试方便

#### 为什么必须有 API 层
- 前端分离 (Web/移动端)
- 米家场景 Webhook 入口
- 第三方集成

**决策**: ✅ **REST API vs WebSocket 留作未来扩展**

---

## 服务层隔离原则

### 三层隔离
```
┌─────────────────────────────┐
│        Orchestration        │  <-- 业务编排
├─────────────────────────────┤
│  Agents (Intent/Planning)   │  <-- 智能决策
├─────────────────────────────┤
│  Services (HA/LLM/Cache)    │  <-- 纯技术栈
└─────────────────────────────┘
```

好处:
- 换 LLM Provider 只动 `services/llm.ts`
- 换设备平台只动 `services/homeassistant.ts`
- Agents 和 Orchestration 保持稳定

**决策**: ✅ **严格分层，单向依赖**

---

## 小爱音箱接入的真实路线

### 可用方案
1. **米家场景 + Webhook** (唯一 production-ready)
   - 用户说话 → 米家识别 → 场景触发 → HTTP 调用本系统
   - 限制: 固定话术

2. **HA Voice (Whisper)** (未来向)
   - 自建 ASR + TTS
   - 问题: 家人接受度

3. **不接入** (务实)
   - 纯 HTTP 测试
   - 移动端 App 手动输入

### 接受现实
- 小爱是消费者产品，不是开发者工具
- 避免破解协议 (不稳定)

**决策**: ✅ **用米家场景 Webhook，暂时牺牲灵活性**

---

## 数据库选择

### 为什么 SQLite/内存 足够
- 缓存是主要数据
- 智能决策发生在内存
- 历史数据不是核心需求
- 真需要持久化再考虑 Redis/PostgreSQL

**决策**: ✅ **SQLite (可选) + 内存缓存，按需扩展**

---

## 开发环境 vs 生产环境的差异

### 开发环境
- Node 热重载 (`tsx watch`)
- Demo 模式无需 HA/LM
- 详细日志

### 生产环境
- 只有 `build` 和 `start` 两个命令
- 环境变量严格验证
- 轻量日志

**决策**: ✅ **一套代码，环境变量驱动差异**

---

## 测试策略

### 短期 (MVP阶段)
- **手动测试** - 每个意图手动验证
- **Demo 模式** - 无需真实设备

### 长期
- 智能体单独单元测试
- 集成测试 (Mock HA/LLM)
- 端到端测试 (真实场景)

**决策**: ✅ **MVP阶段手动测试，避免过度工程**

---

## 未来扩展路径

### 里程碑 1 (已完成)
- ✅ Node.js + TS 项目初始化
- ✅ 三个 Agent 实现
- ✅ HA 基础连接
- ✅ Demo 模式

### 里程碑 2
- 🔲 真实设备集成
- 🔲 小爱 webhook
- 🔲 流程缓存优化

### 里程碑 3  
- 🔲 学习型偏好
- 🔲 设备故障自动处理
- 🔲 移动端 UI

---

**创建时间**: 2025-12-30  
**最后更新**: 2025-12-30  
**状态**: 活跃
**版本**: 1.0.0