---
title: Home Assistant é›†æˆè§„èŒƒ
description: HA API çš„æ¥å…¥ã€å®‰å…¨å’Œæœ€ä½³å®è·µ
scope: src/services/homeassistant.ts, src/agents/context.agent.ts
priority: high
---

# Home Assistant é›†æˆè§„èŒƒ

## ğŸ”‘ è®¤è¯ä¸è®¿é—®ä»¤ç‰Œ

### 1. è·å–é•¿ç”Ÿå‘½å‘¨æœŸä»¤ç‰Œ
```bash
# åœ¨ HA ä¸­:
# ç”¨æˆ·é…ç½® â†’ å®‰å…¨ â†’ é•¿ç”Ÿå‘½å‘¨æœŸè®¿é—®ä»¤ç‰Œ
# åˆ›å»ºæ–°ä»¤ç‰Œï¼Œå¤åˆ¶ä¿å­˜ (åªæ˜¾ç¤ºä¸€æ¬¡)
```

### 2. ç¯å¢ƒå˜é‡é…ç½®
```bash
# .env æ–‡ä»¶
HOME_ASSISTANT_URL=http://homeassistant.local:8123
HOME_ASSISTANT_TOKEN=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

### 3. æ— æ•ˆä»¤ç‰Œå¤„ç†
```typescript
const client = axios.create({
  headers: {
    "Authorization": `Bearer ${token}`
  }
});

client.interceptors.response.use(
  response => response,
  error => {
    if (error.response?.status === 401) {
      console.error("Token æ— æ•ˆï¼Œè¯·æ£€æŸ¥ HA é…ç½®");
    }
    return Promise.reject(error);
  }
);
```

## API åŸºç¡€ç«¯ç‚¹

### 1. è·å–æ‰€æœ‰çŠ¶æ€
```
GET /api/states
```
è¿”å›: æ‰€æœ‰å®ä½“çš„å½“å‰çŠ¶æ€

### 2. è·å–å•ä¸ªå®ä½“çŠ¶æ€
```
GET /api/states/{entity_id}
è¿”å›: 404 è¡¨ç¤ºä¸å­˜åœ¨
```

### 3. è°ƒç”¨æœåŠ¡
```
POST /api/services/{domain}/{service}
Body: { "entity_id": "...", ...å…¶ä»–å‚æ•° }
```

## å®ä½“è¯†åˆ«ä¸ç®¡ç†

### 1. å®ä½“ ID æ ¼å¼
```
<domain>.<object_id>
ç¤ºä¾‹:
- light.living_room
- switch.water_heater  
- climate.thermostat
- sensor.temperature_hall
```

### 2. åŸŸå Domain è¯´æ˜
| Domain | ç±»å‹ | ç¤ºä¾‹ç”¨é€” |
|--------|------|----------|
| `light` | ç¯å…‰ | å¼€å…³è°ƒå…‰ |
| `switch` | å¼€å…³ | æ’åº§ã€çƒ­æ°´å™¨ |
| `climate` | æ¸©æ§ | ç©ºè°ƒã€åœ°æš– |
| `sensor` | ä¼ æ„Ÿå™¨ | æ¸©åº¦ã€æ¹¿åº¦ |
| `fan` | é£æ‰‡ | æ’æ°”æ‰‡ |
| `cover` | è¦†ç›–ç‰© | çª—å¸˜ã€é—¨ |
| `lock` | é” | é—¨é” |

### 3. ç™½åå•å®‰å…¨ç­–ç•¥
```typescript
// æ‰€æœ‰å¯æ§åˆ¶å®ä½“å¿…é¡»æ˜¾å¼å£°æ˜
const ALLOWED_DOMAINS = [
  "light",
  "switch", 
  "climate",
  "fan",
  "cover"
];

function validateEntity(entityId: string): boolean {
  const domain = entityId.split(".")[0];
  return ALLOWED_DOMAINS.includes(domain);
}
```

## è®¾å¤‡çŠ¶æ€æå–

### 1. å¸¸ç”¨çŠ¶æ€å€¼
```typescript
// light, switch, fan, cover
state: "on" | "off"

// cover
state: "open" | "opening" | "closing" | "closed"

// lock
state: "locked" | "unlocked"

// sensor
state: "æ•°å€¼å­—ç¬¦ä¸²"
```

### 2. å±æ€§æå–
```typescript
const device = {
  entityId: entity.entity_id,
  name: entity.attributes.friendly_name,
  state: entity.state,
  // å¸¸ç”¨å±æ€§
  brightness: entity.attributes.brightness,  // ç¯å…‰äº®åº¦
  temperature: entity.attributes.temperature, // æ¸©åº¦
  humidity: entity.attributes.humidity,       // æ¹¿åº¦
  unit_of_measurement: entity.attributes.unit_of_measurement, // å•ä½
};
```

### 3. ç¯å¢ƒçŠ¶æ€æ„ŸçŸ¥
```typescript
// æ—¶é—´
function getTimeOfDay(): "morning" | "afternoon" | "evening" | "night" {
  const hour = new Date().getHours();
  if (hour >= 5 && hour < 12) return "morning";
  if (hour >= 12 && hour < 18) return "afternoon"; 
  if (hour >= 18 && hour < 22) return "evening";
  return "night";
}

// äººåœ¨æ£€æµ‹
function detectPresence(devices: DeviceState[]): boolean {
  const motionSensors = devices.filter(d => 
    d.entityId.includes("person.") || 
    d.entityId.includes("binary_sensor.motion")
  );
  return motionSensors.some(d => d.state === "on");
}

// æ¸©åº¦/æ¹¿åº¦
function extractAverageTemperature(devices: DeviceState[]): number | null {
  const temps = devices
    .filter(d => d.entityId.includes("temperature"))
    .map(d => parseFloat(d.state))
    .filter(n => !isNaN(n));
  
  if (temps.length === 0) return null;
  return Math.round((temps.reduce((a,b) => a+b) / temps.length) * 10) / 10;
}
```

## æœåŠ¡è°ƒç”¨è§„èŒƒ

### 1. åŸºæœ¬æœåŠ¡æ ¼å¼
```typescript
// å¼€å¯è®¾å¤‡
{
  service: "switch.turn_on",
  entity_id: "switch.water_heater"
}

// å…³é—­è®¾å¤‡  
{
  service: "switch.turn_off",
  entity_id: "switch.light"
}

// ç‰¹å®šç¯å…‰
{
  service: "light.turn_on",
  entity_id: "light.living_room",
  brightness_pct: 80  // 80%äº®åº¦
}
```

### 2. æ‰¹é‡æ‰§è¡Œ
```typescript
// ä¸²è¡Œæ‰§è¡Œ (æ¨èï¼Œæ›´å®‰å…¨)
for (const step of plan.steps) {
  try {
    await ha.callService(step.service, step.entityId);
    // å°å»¶è¿Ÿé¿å…HAè¿‡è½½
    await sleep(200);
  } catch (error) {
    results.push({ error, entityId: step.entityId });
  }
}
```

### 3. é”™è¯¯å¤„ç†
```typescript
try {
  await ha.callService("switch.turn_on", "switch.water_heater");
} catch (error) {
  if (error.response?.status === 404) {
    console.error("å®ä½“ä¸å­˜åœ¨");
  } else if (error.response?.status === 500) {
    console.error("è®¾å¤‡æ‰§è¡Œå¤±è´¥");
  }
}
```

## æ€§èƒ½ä¼˜åŒ–

### 1. å‡å°‘ API è°ƒç”¨
```typescript
// âŒ é¿å…: æ¯æ¬¡éœ€æ±‚éƒ½è°ƒç”¨ api/states
async function getInitialState() {
  const states = await ha.getStates(); // ä¸€æ¬¡è·å–æ‰€æœ‰
  return states;
}

// âœ… ç¼“å­˜çŠ¶æ€å¿«ç…§
const CACHE_TTL = 5 * 60 * 1000; // 5åˆ†é’Ÿ
let statesCache: DeviceState[] | null = null;
let cacheTime = 0;

async function getCachedStates(): Promise<DeviceState[]> {
  if (statesCache && Date.now() - cacheTime < CACHE_TTL) {
    return statesCache;
  }
  statesCache = await ha.getStates();
  cacheTime = Date.now();
  return statesCache;
}
```

### 2. æŒ‰éœ€æŸ¥è¯¢
```typescript
// åªéœ€è¦å¼€å…³çŠ¶æ€ï¼Œè°ƒç”¨ç‰¹å®šå®ä½“è€Œéå…¨éƒ¨
const desiredEntityIds = [
  "switch.water_heater",
  "switch.bathroom_heater", 
  "light.bathroom"
];

const states = await ha.getMultipleEntitiesState(desiredEntityIds);
```

## å¥åº·æ£€æŸ¥

### 1. è¿æ¥éªŒè¯
```typescript
async function healthCheck(): Promise<boolean> {
  try {
    const response = await client.get("/api/");
    return response.status === 200;
  } catch {
    return false;
  }
}
```

### 2. ç³»ç»Ÿä¿¡æ¯
```typescript
const config = await client.get("/api/config");
// å†…éƒ¨ç‰ˆæœ¬: config.data.core_version
// åœ°åŒº: config.data.timezone
```

## å®‰å…¨åŸåˆ™

### 1. ä¸è¦ä¿¡ä»»æ‰€æœ‰è®¾å¤‡
```typescript
// âŒ å±é™©: å…è®¸ä»»æ„å®ä½“
async function unsafeControl(entityId: string) {
  await ha.callService("anything.turn_on", entityId); 
}

// âœ… å®‰å…¨: ç™½åå•æ£€æŸ¥
async function safeControl(entityId: string, service: string) {
  if (!validateEntity(entityId)) {
    throw new Error("å®ä½“ä¸åœ¨ç™½åå•");
  }
  if (!validateService(service)) {
    throw new Error("æœåŠ¡ä¸åœ¨ç™½åå•");
  }
  return await ha.callService(service, entityId);
}
```

### 2. æ•æ„Ÿæ“ä½œä¿æŠ¤
```typescript
const SENSITIVE_SERVICES = [
  "lock.unlock",
  "valve.open",
  "dangerous.action"
];

function requiresConfirmation(service: string, entityId: string): boolean {
  if (SENSITIVE_SERVICES.some(s => service.startsWith(s))) {
    return true;
  }
  if (entityId.includes("gas") || entityId.includes("dangerous")) {
    return true;
  }
  return false;
}
```

### 3. é€Ÿç‡é™åˆ¶
```typescript
// é¿å…è¿‡å¿«è°ƒç”¨ HA API
const MIN_INTERVAL = 100; // ms
let lastCall = 0;

async function rateLimitedCall(service: string, entity: string) {
  const now = Date.now();
  if (now - lastCall < MIN_INTERVAL) {
    await sleep(MIN_INTERVAL - (now - lastCall));
  }
  lastCall = Date.now();
  return await ha.callService(service, entity);
}
```

## è°ƒè¯•ä¸æ—¥å¿—

### 1. ç¯å¢ƒå˜é‡
```bash
# å¼€å‘ç¯å¢ƒæ˜¾ç¤ºè¯¦ç»†æ—¥å¿—
export NODE_ENV=development
```

### 2. æ—¥å¿—æ ¼å¼
```typescript
console.log(`[HA] è·å–çŠ¶æ€: ${entityId}`);
console.log(`[HA] æ‰§è¡ŒæœåŠ¡: ${service} on ${entityId}`);
console.log(`[HA] âœ… æˆåŠŸ: ${result}`);
console.error(`[HA] âŒ å¤±è´¥: ${error.message}`);
```

### 3. æ•°æ®æ”¶é›†
```typescript
// ç”¨äºè°ƒè¯•: å¯¼å‡ºå®ä½“åˆ—è¡¨
async function debugExportEntities() {
  const states = await ha.getStates();
  const output = states.map(s => ({
    entity_id: s.entityId,
    name: s.entityName,
    state: s.state,
    domain: s.entityId.split(".")[0]
  }));
  console.log(JSON.stringify(output, null, 2));
  return output;
}
```

## å®ä½“ä¿¡æ¯æ”¶é›†

```bash
# è¯·è¿è¡Œæ­¤å‘½ä»¤è·å–ä½ çš„å®ä½“åˆ—è¡¨
# curl -H "Authorization: Bearer YOUR_TOKEN" \
#      http://homeassistant.local:8123/api/states
```

### å¸¸è§å®ä½“ç¤ºä¾‹
```typescript
// çƒ­æ°´å™¨
"switch.water_heater"
"switch.gas_water_heater"

// æµ´éœ¸/æš–é£
"switch.bathroom_heater"
"fan.bathroom_vent"

// ç¯å…‰
"light.bathroom"
"light.living_room"

// æ¸©åº¦ä¼ æ„Ÿå™¨
"sensor.temperature_living_room"
"sensor.humidity_bathroom"

// äººåœ¨æ£€æµ‹
"binary_sensor.motion_bathroom"
"binary_sensor.occupancy_living_room"
```

## æ¼”ç¤ºæ¨¡å¼

å¦‚æœæœªé…ç½® HA Tokenï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è¿›å…¥æ¼”ç¤ºæ¨¡å¼ï¼Œæ­¤æ—¶:
- âœ… æ‰€æœ‰ API è°ƒç”¨æ­£å¸¸
- âœ… ä¸ä¼šçœŸå®æ“ä½œè®¾å¤‡
- âœ… è®°å½•"æ¨¡æ‹Ÿæ‰§è¡Œ"æ—¥å¿—
- âœ… é€‚åˆå¼€å‘ç¯å¢ƒ

---

## å¿«é€Ÿæ£€æŸ¥æ¸…å•

```bash
# 1. Token æœ‰æ•ˆ
curl -H "Authorization: Bearer $HA_TOKEN" \
     $HA_URL/api/states

# 2. å®ä½“å­˜åœ¨
curl ... | grep "switch.water_heater"

# 3. å¯æ§åˆ¶
# æµ‹è¯•æ‰‹åŠ¨è°ƒç”¨
curl -X POST \
  -H "Authorization: Bearer $HA_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"entity_id": "switch.water_heater"}' \
  $HA_URL/api/services/switch/turn_on
```

**ç¬”è®°**:
- æµ‹è¯•ç¯å¢ƒæ¨èä½¿ç”¨ Demo æ¨¡å¼
- ç”Ÿäº§ç¯å¢ƒå¿…é¡»å®Œæ•´æ ¡éªŒ
- å°çˆ±éŸ³ç®±åªèƒ½ç”¨ Webhook æ–¹å¼è§¦å‘

**å·²å®ç°**:
- âœ… åŸºç¡€æœåŠ¡å±‚ (src/services/homeassistant.ts)
- âœ… çŠ¶æ€æå– (src/agents/context.agent.ts)
- âœ… æ‰¹é‡æ‰§è¡Œ
- â³ å®ä½“ç™½åå•é…ç½®å¾…æ·»åŠ 