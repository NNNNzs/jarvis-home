---
title: JARVIS é¡¹ç›®å¼€å‘æŒ‡å—
description: å¤šæ™ºèƒ½ä½“æ™ºèƒ½å®¶å±…ç³»ç»Ÿçš„æŠ€æœ¯è§„èŒƒå’Œå¼€å‘æŒ‡å—
scope: project
priority: high
---

# JARVIS é¡¹ç›®å¼€å‘æŒ‡å—

## ğŸ¯ é¡¹ç›®æ¦‚è¿°

**Just A Rather Very Intelligent System (JARVIS)** æ˜¯ä¸€ä¸ªåŸºäº **Node.js + TypeScript** çš„å¤šæ™ºèƒ½ä½“ååŒç³»ç»Ÿï¼Œç”¨äºæ™ºèƒ½å®¶å±…æ§åˆ¶ã€‚

- **æ ¸å¿ƒæŠ€æœ¯**: LangChain + LangGraph + Express
- **æ ¸å¿ƒåŠŸèƒ½**: è‡ªç„¶è¯­è¨€ç†è§£ â†’ æ„å›¾è¯†åˆ« â†’ çŠ¶æ€æ„ŸçŸ¥ â†’ è¡Œä¸ºè§„åˆ’ â†’ è®¾å¤‡æ‰§è¡Œ
- **ä¸»è¦é›†æˆ**: Home Assistant (çŠ¶æ€ä¸­æ¢) + OpenAI (LLM)

## ğŸ“ ä»£ç è§„èŒƒ

### 1. è¯­è¨€å’Œæ ¼å¼
- âœ… ä½¿ç”¨ **TypeScript**ï¼Œå¼€å¯ä¸¥æ ¼æ¨¡å¼ (`strict: true`)
- âœ… ä½¿ç”¨ **ES Modules** (`import/export`)ï¼Œä¸æ˜¯ CommonJS
- âœ… ä½¿ç”¨ **ES2022** æˆ–æ›´é«˜è¯­æ³•
- âœ… æ–‡ä»¶åç¼€: `.ts` (æºç ) å’Œ `.js` (ç¼–è¯‘åï¼Œä¸è¦æ‰‹åŠ¨ç¼–è¾‘)

### 2. å‘½åè§„èŒƒ
```typescript
// âœ… å¥½çš„å‘½å
const homeAssistantService: HomeAssistantService;
const intentAgent: IntentAgent;
const generatePlan(): Promise<Plan>

// âŒ é¿å…
const haService: any;      // ä¸è¦ä½¿ç”¨ any
const processIntent()      // ä¸å¤Ÿè¯­ä¹‰åŒ–
```

- **ç±»å**: `PascalCase` (Example: `Orchestrator`, `IntentAgent`)
- **å˜é‡/å‡½æ•°å**: `camelCase` (example: `generatePlan`, `userInput`)
- **å¸¸é‡**: `UPPER_SNAKE_CASE` (example: `DEFAULT_TIMEOUT`)
- **æšä¸¾å€¼**: `UPPER_SNAKE_CASE` (example: `IntentType.BATH_PREPARE`)

### 3. é¡¹ç›®ç»“æ„
```
src/
â”œâ”€â”€ agents/          # æ™ºèƒ½ä½“æ¨¡å—
â”‚   â”œâ”€â”€ intent.ts    # æ„å›¾è¯†åˆ«
â”‚   â”œâ”€â”€ context.ts   # çŠ¶æ€æ„ŸçŸ¥  
â”‚   â””â”€â”€ planner.ts   # è¡Œä¸ºè§„åˆ’
â”œâ”€â”€ services/        # æœåŠ¡å±‚ (å¤–éƒ¨äº¤äº’)
â”‚   â”œâ”€â”€ homeassistant.ts
â”‚   â”œâ”€â”€ llm.ts
â”‚   â””â”€â”€ cache.ts
â”œâ”€â”€ api/             # HTTP æ¥å£
â”‚   â”œâ”€â”€ routes.ts
â”‚   â””â”€â”€ middleware.ts
â”œâ”€â”€ types/           # ç±»å‹å®šä¹‰
â”‚   â””â”€â”€ index.ts
â”œâ”€â”€ orchestrator.ts  # æ ¸å¿ƒåè°ƒå™¨
â””â”€â”€ app.ts          # åº”ç”¨å…¥å£
```

## ğŸ—ï¸ æ¶æ„åŸåˆ™

### 1. å•ä¸€èŒè´£
æ¯ä¸ªæ–‡ä»¶åªè´Ÿè´£ä¸€ä¸ªæ˜ç¡®çš„åŠŸèƒ½:
- `services/` çº¯ç²¹å¤„ç†ä¸å¤–éƒ¨ç³»ç»Ÿçš„ API äº¤äº’
- `agents/` çº¯ç²¹å¤„ç†ä¸šåŠ¡é€»è¾‘å’Œå†³ç­–
- `orchestrator.ts` è´Ÿè´£ç¼–æ’æµç¨‹ï¼Œä¸å¤„ç†ç»†èŠ‚

### 2. ä¸å¯å˜æ€§å’Œç±»å‹å®‰å…¨
```typescript
// âœ… ä½¿ç”¨ Zod ä¿è¯è¿è¡Œæ—¶å®‰å…¨
const InputSchema = z.object({
  message: z.string().min(1)
});
type UserInput = z.infer<typeof InputSchema>;

// âœ… ä½¿ç”¨æšä¸¾å®šä¹‰å¸¸é‡
export enum IntentType {
  BATH_PREPARE = "bath_prepare",
  SLEEP = "sleep",
  // ...
}
```

### 3. é”™è¯¯å¤„ç†å’Œå¯æ¢å¤æ€§
- æ‰€æœ‰å¤–éƒ¨ API è°ƒç”¨éƒ½è¦æœ‰ try-catch
- LLM å¤±è´¥å¿…é¡»æœ‰è§„åˆ™å…œåº•
- ä¸è¦è®©ç³»ç»Ÿå› å•ä¸ªç»„ä»¶å¤±è´¥è€Œå´©æºƒ

### 4. æ—¥å¿—å’Œå¯è§‚æµ‹æ€§
```typescript
console.log(`[Orchestrator] è¯†åˆ«æ„å›¾: ${intent.intent}`);
console.error(`[Error] HA è°ƒç”¨å¤±è´¥: ${error.message}`);
```

## ğŸ”’ å®‰å…¨è¦æ±‚

### 1. ç¯å¢ƒå˜é‡
- **ç»ä¸** æäº¤ `.env` æ–‡ä»¶åˆ°ç‰ˆæœ¬æ§åˆ¶
- ä½¿ç”¨ `.env.example` ä½œä¸ºæ¨¡æ¿
- API Key å’Œ Token å¿…é¡»æ”¾åœ¨ `process.env`

### 2. è¾“å…¥éªŒè¯
```typescript
// âœ… éªŒè¯æ‰€æœ‰è¾“å…¥
const input = UserInputSchema.parse(req.body);
```

### 3. è®¾å¤‡æ§åˆ¶å®‰å…¨
- ç™½åå•æœºåˆ¶ï¼Œåªæ§åˆ¶å£°æ˜è¿‡çš„è®¾å¤‡
- é‡è¦æ“ä½œ(ç‡ƒæ°”ã€é—¨é”)éœ€äºŒæ¬¡ç¡®è®¤
- æ‰€æœ‰æ“ä½œå¿…é¡»å¯è¿½æº¯

## ğŸ’¡ å¼€å‘æµç¨‹

### 1. åˆå§‹åŒ–å¼€å‘ç¯å¢ƒ
```bash
pnpm install
# åˆ›å»º .env æ–‡ä»¶å¹¶å¡«å…¥é…ç½®
cp .env.example .env
```

### 2. å¼€å‘å¯åŠ¨
```bash
pnpm dev      # å¼€å‘æ¨¡å¼ï¼Œçƒ­é‡è½½
pnpm build    # ç¼–è¯‘ TypeScript
pnpm start    # ç”Ÿäº§è¿è¡Œ
```

### 3. æµ‹è¯•æ¥å£ (Demo æ¨¡å¼ æ— éœ€ HA)
```bash
# æ„å›¾è¯†åˆ«æµ‹è¯•
curl -X POST http://localhost:3000/api/demo \
  -H "Content-Type: application/json" \
  -d '{"message": "æˆ‘è¦æ´—æ¾¡äº†"}'

# ç³»ç»ŸçŠ¶æ€
curl http://localhost:3000/api/status
```

### 4. æäº¤å‰æ£€æŸ¥
- æ‰€æœ‰ç±»å‹å®šä¹‰æ­£ç¡® (æ—  `any`)
- é”™è¯¯å¤„ç†å¦¥å½“
- æ—¥å¿—æ¸…æ™°
- æ•°æ®åº“/ç¼“å­˜æ“ä½œå®‰å…¨

## ğŸ”„ å…³é”®å·¥ä½œæµç¨‹

**è¯¦ç»†æµç¨‹å›¾**: å‚è§ `docs/system-flowchart.drawio`

```mermaid
ç”¨æˆ·è¾“å…¥ â†’ Intent Agent â†’ Context Agent â†’ Planner Agent â†’ æ‰§è¡Œ â†’ ç¼“å­˜
     â†“          â†“            â†“              â†“            â†“       â†“
   éªŒè¯      æ„å›¾è¯†åˆ«     çŠ¶æ€è·å–      è®¡åˆ’ç”Ÿæˆ     HA API   å­˜å‚¨
```

### æµç¨‹å›¾ç»´æŠ¤è§„åˆ™

âš ï¸ **é‡è¦**: å½“ç³»ç»Ÿæµç¨‹å‘ç”Ÿå˜æ›´æ—¶ï¼Œå¿…é¡»åŒæ­¥æ›´æ–°æµç¨‹å›¾ï¼

**æµç¨‹å›¾ä½ç½®**: `docs/system-flowchart.drawio`

**éœ€è¦æ›´æ–°æµç¨‹å›¾çš„åœºæ™¯**:
1. æ–°å¢æˆ–åˆ é™¤æ™ºèƒ½ä½“ (Agent)
2. æ–°å¢æˆ–åˆ é™¤æœåŠ¡ (Service)
3. ä¿®æ”¹ Orchestrator çš„å¤„ç†æµç¨‹
4. æ–°å¢æˆ–ä¿®æ”¹ API ç«¯ç‚¹
5. ä¿®æ”¹ä¸­é—´ä»¶å¤„ç†é€»è¾‘
6. æ–°å¢æˆ–ä¿®æ”¹ç¼“å­˜æœºåˆ¶
7. ä¿®æ”¹é”™è¯¯å¤„ç†æµç¨‹

**æ›´æ–°æµç¨‹**:
1. ä½¿ç”¨ [draw.io](https://app.diagrams.net/) æ‰“å¼€ `docs/system-flowchart.drawio`
2. æ ¹æ®ä»£ç å˜æ›´æ›´æ–°æµç¨‹å›¾
3. ç¡®ä¿æµç¨‹å›¾ä¸ä»£ç å®ç°ä¿æŒä¸€è‡´
4. æäº¤ä»£ç æ—¶åŒæ—¶æäº¤æ›´æ–°çš„æµç¨‹å›¾

è¯¦è§ `.cursor/rules/flowchart-maintenance.mdc`

### å„æ™ºèƒ½ä½“èŒè´£

**Intent Agent**:
- è¾“å…¥: çº¯æ–‡æœ¬
- è¾“å‡º: æ ‡å‡†åŒ–æ„å›¾ (`{intent, confidence, rawInput}`)
- æ‰‹æ®µ: è§„åˆ™ä¼˜å…ˆ + LLM ç²¾ç¡®

**Context Agent**:  
- å®šæ—¶è·å– HA çŠ¶æ€å¿«ç…§
- æå–ç¯å¢ƒä¿¡æ¯ (æ—¶é—´ã€æ¸©åº¦ã€äººåœ¨)
- è¾“å‡º: `ContextState`

**Planner Agent**:
- è¾“å…¥: æ„å›¾ + ä¸Šä¸‹æ–‡
- å°è¯•ç¼“å­˜åŒ¹é…
- è¾“å‡º: å¯æ‰§è¡Œè®¡åˆ’ (`Plan`)
- ä¸ç›´æ¥æ‰§è¡Œ

**Orchestrator**:
- ç»Ÿä¸€å…¥å£
- è°ƒåº¦æ‰€æœ‰ Agent
- å¤„ç†é”™è¯¯å’Œå…œåº•

## ğŸŒ API è®¾è®¡

### ç»Ÿä¸€å“åº”æ ¼å¼
```typescript
{
  "success": true,
  "data": {...},
  "timestamp": "2024-01-01T00:00:00Z"
}
```

### ä¸»è¦ç«¯ç‚¹
- `POST /api/intent` - å¤„ç†ç”¨æˆ·æ„å›¾
- `GET /api/status` - ç³»ç»ŸçŠ¶æ€
- `GET /api/health` - å¥åº·æ£€æŸ¥
- `POST /api/demo` - æ¼”ç¤ºæ¨¡å¼ (æ¨èå¼€å‘æ—¶ä½¿ç”¨)
- `POST /api/cache/clear` - æ¸…ç©ºç¼“å­˜

## ğŸ” è°ƒè¯•æŠ€å·§

### ç¯å¢ƒå˜é‡è°ƒè¯•
```bash
export OPENAI_API_KEY=your_key
export HOME_ASSISTANT_URL=http://homeassistant.local:8123
export NODE_ENV=development
```

### æ—¥å¿—ç­‰çº§
```typescript
// å¼€å‘æ—¥å¿—
console.log(`[Debug] ${details}`);

// è­¦å‘Š
console.warn(`âš ï¸  ${warning}`);

// é”™è¯¯
console.error(`[Error] ${error}`);
```

### Demo æ¨¡å¼
ä¸é…ç½® HA Token æ—¶ï¼Œç³»ç»Ÿä¼šè¿›å…¥æ¼”ç¤ºæ¨¡å¼ï¼Œä»…æ¨¡æ‹Ÿæ‰§è¡Œï¼Œéå¸¸é€‚åˆå‰ç«¯å¼€å‘è°ƒè¯•ã€‚

## ğŸ“‹ é…ç½®æ–‡ä»¶è¯´æ˜

### tsconfig.json
- `strict: true` - å¼ºåˆ¶ç±»å‹å®‰å…¨
- `module: "commonjs"` - å…¼å®¹æ€§ (å¯å‡çº§åˆ° ESM)
- `outDir: "./dist"` - ç¼–è¯‘è¾“å‡ºç›®å½•

### package.json
- `type: "module"` - ä½¿ç”¨ ES Modules
- åŒ…å« `dev` å’Œ `start` è„šæœ¬

### ç¯å¢ƒå˜é‡ (.env)
```ini
# å¿…éœ€
OPENAI_API_KEY=sk-...
HOME_ASSISTANT_TOKEN=xxx (å¯é€‰ï¼Œdemoæ¨¡å¼ä¸éœ€è¦)

# å¯é€‰
CACHE_STRATEGY=context_aware
NODE_ENV=development
```

## ğŸš¨ å¸¸è§é™·é˜±

1. **ä¸è¦ç›´æ¥ä¿®æ”¹ `dist/` æ–‡ä»¶å¤¹** - è¿™æ˜¯ç¼–è¯‘äº§ç‰©
2. **ä¸è¦ç”¨ `any` ç±»å‹** - ç”¨ Zod æˆ–æ˜ç¡®æ¥å£
3. **å¿˜è®°é”™è¯¯å¤„ç†** - LLM å’Œ HA éƒ½ä¸ç¨³å®š
4. **ç¡¬ç¼–ç é…ç½®** - å…¨éƒ¨èµ°ç¯å¢ƒå˜é‡
5. **å•çº¿ç¨‹é˜»å¡** - å¼‚æ­¥æ‰€æœ‰å¤–éƒ¨è°ƒç”¨

## ğŸ”§ ä¾èµ–æ›´æ–°ç­–ç•¥

```bash
# åªå‡çº§æ¬¡è¦ç‰ˆæœ¬
pnpm update --latest
# è¿è¡Œæµ‹è¯•ç¡®ä¿å…¼å®¹

# é‡å¤§ç‰ˆæœ¬å‡çº§æ‰‹åŠ¨æ£€æŸ¥
# 1. CHANGELOG
# 2. API breaking changes  
# 3. æ›´æ–° interfaces.ts
```

## ğŸ“ Git æäº¤è§„èŒƒ

æœ¬é¡¹ç›®ä½¿ç”¨ **Conventional Commits** è§„èŒƒï¼Œè¯¦è§ `.cursor/rules/git-commit.mdc`ã€‚

**å¿«é€Ÿå‚è€ƒ**ï¼š
- `feat(scope): æè¿°` - æ–°åŠŸèƒ½
- `fix(scope): æè¿°` - Bug ä¿®å¤
- `docs(scope): æè¿°` - æ–‡æ¡£æ›´æ–°
- `refactor(scope): æè¿°` - ä»£ç é‡æ„

**æäº¤å‰æ£€æŸ¥**ï¼š
```bash
pnpm build    # ç¡®ä¿ç¼–è¯‘é€šè¿‡
pnpm lint     # ç¡®ä¿ä»£ç è§„èŒƒ
```

---

**æœ€åä¿®æ”¹**: 2025-12-30  
**ç»´æŠ¤è€…**: @User  
**ç‰ˆæœ¬**: 1.0.0