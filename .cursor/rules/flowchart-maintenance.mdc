---
title: 流程图维护规则
description: 确保系统流程图与代码实现保持同步的规则和流程
scope: project
priority: high
---

# 流程图维护规则

## 📊 流程图位置

**主流程图**: `docs/system-flowchart.drawio`

这是一个使用 [draw.io](https://app.diagrams.net/) 创建的流程图文件，描述了 JARVIS 系统的完整处理流程。

## 🔄 何时需要更新流程图

当以下情况发生时，**必须**同步更新流程图：

### 1. 架构变更
- ✅ 新增或删除智能体 (Agent)
- ✅ 新增或删除服务 (Service)
- ✅ 修改智能体之间的调用关系
- ✅ 新增或删除中间件

### 2. 流程变更
- ✅ 修改 `Orchestrator.processUserIntent()` 的处理步骤
- ✅ 修改智能体的执行顺序
- ✅ 新增或删除处理步骤
- ✅ 修改错误处理流程

### 3. API 变更
- ✅ 新增或删除 API 端点
- ✅ 修改 API 路由结构
- ✅ 修改请求/响应流程

### 4. 功能变更
- ✅ 新增或修改缓存机制
- ✅ 新增或修改执行逻辑
- ✅ 修改数据流向

## 📝 更新流程

### 步骤 1: 识别变更
在修改代码前，先评估是否需要更新流程图：
- 是否影响系统的主要流程？
- 是否改变了组件之间的关系？
- 是否新增或删除了关键步骤？

### 步骤 2: 更新流程图
1. 使用 [draw.io](https://app.diagrams.net/) 打开 `docs/system-flowchart.drawio`
   - 在线版: https://app.diagrams.net/
   - VS Code 插件: Draw.io Integration
   - 桌面版: https://github.com/jgraph/drawio-desktop

2. 根据代码变更更新流程图：
   - 添加新组件（智能体、服务等）
   - 删除已废弃的组件
   - 更新箭头和连接关系
   - 更新组件说明文字
   - 更新流程说明区域

3. 确保流程图元素：
   - ✅ 颜色编码正确（参考图例）
   - ✅ 箭头方向正确
   - ✅ 文字描述准确
   - ✅ 布局清晰易读

### 步骤 3: 验证一致性
更新后，检查以下内容：
- [ ] 流程图中的组件与代码中的类/模块对应
- [ ] 流程顺序与代码执行顺序一致
- [ ] 所有关键步骤都已包含
- [ ] 错误处理流程已更新（如有变更）

### 步骤 4: 提交变更
在提交代码时，**同时提交更新的流程图**：

```bash
git add docs/system-flowchart.drawio
git commit -m "feat(orchestrator): 新增错误重试机制

- 在 Orchestrator 中添加重试逻辑
- 更新流程图以反映新的错误处理流程"
```

## 🎨 流程图规范

### 颜色编码
- **蓝色** (`#dae8fc`): 入口/出口节点（用户请求、响应返回）
- **黄色** (`#fff2cc`): API 路由层
- **紫色** (`#e1d5e7`): 中间件层
- **红色** (`#f8cecc`): 协调器 (Orchestrator)
- **绿色** (`#d5e8d4`): 智能体 (Agents)
- **橙色** (`#ffe6cc`): 服务层 (Services)
- **灰色** (`#f5f5f5`): 执行流程

### 箭头类型
- **实线箭头**: 主流程（数据流向）
- **虚线箭头**: 服务调用（组件间调用）

### 组件命名
- 使用清晰的组件名称
- 包含文件名（如 `routes.ts`）
- 包含关键方法名（如 `processUserIntent()`）

## 🔍 检查清单

在提交代码前，使用以下检查清单：

- [ ] 代码变更是否影响系统流程？
- [ ] 如果是，流程图是否已更新？
- [ ] 流程图中的组件是否与代码一致？
- [ ] 流程顺序是否正确？
- [ ] 所有新增的组件是否已添加到流程图？
- [ ] 所有删除的组件是否已从流程图移除？
- [ ] 流程图文件是否可以正常打开？
- [ ] 流程图布局是否清晰易读？

## 📚 流程图结构说明

当前流程图包含以下主要部分：

1. **入口层**: 用户请求、API 路由、中间件
2. **协调层**: Orchestrator（核心编排）
3. **智能体层**: Intent Agent、Context Agent、Planner Agent
4. **服务层**: LLM Service、HA Service、Cache Service
5. **执行层**: 计划执行
6. **出口层**: 响应返回
7. **说明区域**: 详细流程说明、缓存机制、错误处理

## 🛠️ 工具推荐

### 编辑流程图
- **在线版**: https://app.diagrams.net/ (推荐)
- **VS Code 插件**: Draw.io Integration
- **桌面版**: https://github.com/jgraph/drawio-desktop

### 查看流程图
- 直接在 draw.io 中打开 `.drawio` 文件
- 或使用支持 draw.io 的编辑器

## ⚠️ 注意事项

1. **不要删除流程图文件**: 即使系统重构，也要保留历史版本
2. **保持版本同步**: 流程图版本应与代码版本对应
3. **定期审查**: 在代码审查时，检查流程图是否与代码一致
4. **文档化变更**: 在提交信息中说明流程图的变更原因

## 📖 相关文档

- 项目架构: `.cursor/rules/project-guidelines.mdc`
- API 设计: `README.md`
- 代码规范: `.cursor/rules/project-guidelines.mdc`

---

**最后修改**: 2025-01-01  
**维护者**: @User  
**版本**: 1.0.0
